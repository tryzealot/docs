"use strict";(self.webpackChunkzealot_new_docs=self.webpackChunkzealot_new_docs||[]).push([[4604],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=r.createContext({}),p=function(e){var t=r.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=p(e.components);return r.createElement(i.Provider,{value:t},e.children)},m="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=p(n),u=a,h=m["".concat(i,".").concat(u)]||m[u]||c[u]||o;return n?r.createElement(h,l(l({ref:t},d),{},{components:n})):r.createElement(h,l({ref:t},d))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=u;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s[m]="string"==typeof e?e:a,l[1]=s;for(var p=2;p<o;p++)l[p]=n[p];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},7148:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const o={sidebar_label:"Nomad"},l="Deploy Zealot with Nomad guide",s={unversionedId:"self-hosted/deployment/nomad",id:"self-hosted/deployment/nomad",title:"Deploy Zealot with Nomad guide",description:"Zealot support deployments using Nomad, it use HCL language to configure.",source:"@site/docs/self-hosted/deployment/nomad.md",sourceDirName:"self-hosted/deployment",slug:"/self-hosted/deployment/nomad",permalink:"/docs/next/self-hosted/deployment/nomad",draft:!1,editUrl:"https://github.com/tryzealot/docs/tree/main/docs/self-hosted/deployment/nomad.md",tags:[],version:"current",frontMatter:{sidebar_label:"Nomad"},sidebar:"selfHosted",previous:{title:"Kubernetes",permalink:"/docs/next/self-hosted/deployment/kubernetes"},next:{title:"Source code",permalink:"/docs/next/self-hosted/deployment/source-code"}},i={},p=[{value:"Setup",id:"setup",level:2},{value:"Using Nomad",id:"using-nomad",level:3},{value:"Using Terraform",id:"using-terraform",level:3},{value:"External Storages",id:"external-storages",level:2},{value:"CSI",id:"csi",level:3}],d={toc:p},m="wrapper";function c(e){let{components:t,...n}=e;return(0,a.kt)(m,(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"deploy-zealot-with-nomad-guide"},"Deploy Zealot with Nomad guide"),(0,a.kt)("p",null,"Zealot support deployments using ",(0,a.kt)("a",{parentName:"p",href:"https://www.nomadproject.io/"},"Nomad"),", it use ",(0,a.kt)("a",{parentName:"p",href:"https://developer.hashicorp.com/nomad/docs/job-specification/hcl2"},"HCL")," language to configure."),(0,a.kt)("h2",{id:"setup"},"Setup"),(0,a.kt)("h3",{id:"using-nomad"},"Using Nomad"),(0,a.kt)("p",null,"First, follow the official tutorial to install ",(0,a.kt)("a",{parentName:"p",href:"https://developer.hashicorp.com/nomad/docs/install"},"nomad"),", this binary file contains the client and server. It is recommended to follow the ",(0,a.kt)("a",{parentName:"p",href:"https://developer.hashicorp.com/nomad/tutorials/get-started"},"tutorials")," to walk through it if you don't know it."),(0,a.kt)("p",null,"The following file will create the postgres, redis and zealot services.\nFor the existing external database and cache services,\nyou can delete the corresponding ",(0,a.kt)("inlineCode",{parentName:"p"},"port"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"service")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"task")," and edit the template variables in the ",(0,a.kt)("inlineCode",{parentName:"p"},"zealot")," task."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-hcl",metastring:'title="zealot.nomad"',title:'"zealot.nomad"'},'job "zealot" {\n  type        = "service"\n  datacenters = "dc1"     // modify\n\n  update {\n    max_parallel      = 1\n    min_healthy_time  = "30s"\n    auto_revert       = true\n  }\n\n  group "zealot" {\n    network {\n      port "zealot" {\n        to = 80\n      }\n\n      port "postgres" {\n        to = 5678\n      }\n\n      port "redis" {\n        to = 6379\n      }\n    }\n\n    service {\n      name = "zealot"\n      port = "zealot"\n      provider = "nomad"\n\n      // Register to traefik\n      // tags = [\n      //   "traefik.enable=true",\n      //   "traefik.http.routers.zealot.entrypoints=web, websecure",\n      //   "traefik.http.routers.zealot.rule=Host(`zealot.example.com`)",\n      // ]\n    }\n\n    service {\n      name = "postgres"\n      port = "postgres"\n      provider = "nomad"\n\n      // Register to traefik\n      // tags = [\n      //   "traefik.enable=true",\n      //   "traefik.tcp.routers.postgres.rule=HostSNI(`*`)",\n      //   "traefik.tcp.routers.postgres.entrypoints=postgres",\n      // ]\n    }\n\n    service {\n      name = "redis"\n      port = "redis"\n      provider = "nomad"\n\n      // Register to traefik\n      // tags = [\n      //   "traefik.enable=true",\n      //   "traefik.tcp.routers.redis.rule=HostSNI(`*`)",\n      //   "traefik.tcp.routers.redis.entrypoints=redis",\n      // ]\n    }\n\n    task "zealot" {\n      driver = "docker"\n\n      config {\n        image = "ghcr.io/tryzealot/zealot:latest"\n        ports = ["zealot"]\n\n        // modify\n        volumes = [\n          "/tmp/zealot/uploads:/app/public/uploads",\n          "/tmp/zealot/backups:/app/public/backups",\n        ]\n\n        // Register to homepage dashboard\n        // labels = {\n        //   "homepage.group"        = "Dev"\n        //   "homepage.name"         = "Zealot"\n        //   "homepage.icon"         = "mdi-progress-download"\n        //   "homepage.href"         = "https://zealot.example.com"\n        //   "homepage.description"  = "Beta App Distribution"\n        // }\n      }\n\n      // Zealot example config\n      // https://github.com/tryzealot/zealot-docker/blob/master/config.env\n      template {\n        destination = "local/config.env"\n        change_mode = "restart"\n        env         = true\n        data        = <<-EOF\n        ZEALOT_APPEARANCE = dark\n        ZEALOT_DOMAIN = zealot.example.com\n\n        ZEALOT_GUEST_MODE = false\n        ZEALOT_REGISTER_ENABLED = true\n        EOF\n      }\n\n      template {\n        destination = "secrets/secret.env"\n        change_mode = "restart"\n        env         = true\n        data        = <<-EOF\n        # admin account\n        ZEALOT_ADMIN_EMAIL = admin@zealot.com\n        ZEALOT_ADMIN_PASSWORD = ze@l0t\n\n        # datbase\n        ZEALOT_POSTGRES_HOST = {{ env "NOMAD_IP_postgres" }}\n        ZEALOT_POSTGRES_PORT = {{ env "NOMAD_PORT_postgres" }}\n        ZEALOT_POSTGRES_USERNAME = "zealot"\n        ZEALOT_POSTGRES_PASSWORD = "zealot"\n        ZEALOT_POSTGRES_DB_NAME = "zealot"\n\n        # cache\n        REDIS_URL = redis://{{ env "NOMAD_ARRR_redis" }}/0\n\n        # secret token\n        SECRET_TOKEN = $${ sha256(uuidv5("url", "zealot.ews.im")) }\n        EOF\n      }\n\n      resources {\n        cpu         = 500\n        memory      = 500\n        memory_max  = 1000\n      }\n    }\n\n    task "postgres" {\n      driver = "docker"\n\n      lifecycle {\n        hook = "prestart"\n        sidecar = true\n      }\n\n      config {\n        image = "postgres:14-alpine"\n        ports = ["postgres"]\n        volumes = [\n          "secrets/init-role.sql:/init-role.sql",\n          "secrets/init-db.sql:/init-db.sql"\n        ]\n      }\n\n      env {\n        POSTGRES_INITDB_ARGS  = "--data-checksums"\n        POSTGRES_USER         = "zealot"\n        POSTGRES_PASSWORD     = "zealot"\n        POSTGRES_DB           = "zealot"\n      }\n\n      resources{\n        cpu         = 512\n        memory      = 200\n        memory_max  = 512\n      }\n    }\n\n    task "redis" {\n      driver = "docker"\n\n      lifecycle {\n        hook = "prestart"\n        sidecar = true\n      }\n\n      config {\n        image = "redis:5-alpine"\n        ports = ["redis"]\n      }\n\n      resources {\n        cpu    = 200\n        memory = 200\n      }\n    }\n  }\n}\n')),(0,a.kt)("p",null,"Save the file and execute the command ",(0,a.kt)("inlineCode",{parentName:"p"},"nomad job run zealot.nomad"),"."),(0,a.kt)("h3",{id:"using-terraform"},"Using Terraform"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Both Terraform and Nomad are the same company.")),(0,a.kt)("p",null,"Following the offical tutorials to install ",(0,a.kt)("a",{parentName:"p",href:"https://www.terraform.io/"},"terraform"),", ",(0,a.kt)("a",{parentName:"p",href:"https://registry.terraform.io/providers/hashicorp/nomad/"},"nomad plugin"),",\ncopy the ",(0,a.kt)("inlineCode",{parentName:"p"},"zealot.nomad")," in previous step and edit a new file named ",(0,a.kt)("inlineCode",{parentName:"p"},"main.tf"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-hcl"},'resource "nomad_job" "jobs" {\n  jobspec = file("${path.module}/zealot.nomad")\n}\n')),(0,a.kt)("p",null,"Execute ",(0,a.kt)("inlineCode",{parentName:"p"},"terraform plan")," to ensure, then deploy ",(0,a.kt)("inlineCode",{parentName:"p"},"terraform apply"),"."),(0,a.kt)("h2",{id:"external-storages"},"External Storages"),(0,a.kt)("p",null,"Nomad supports multi-cluster management, and in many cases the storage deployed by the service cannot be mounted directly to the corresponding file system, but is more often placed on top of a shared file storage protocol, such as SMB, NFS, S3, etc."),(0,a.kt)("h3",{id:"csi"},"CSI"),(0,a.kt)("p",null,"Nomad currently supports the ",(0,a.kt)("a",{parentName:"p",href:"https://developer.hashicorp.com/nomad/tutorials/stateful-workloads/stateful-workloads-csi-volumes"},"CSI")," in ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/democratic-csi/democratic-csi/blob/master/docs/nomad.md"},"a limited capability")," (Nomad 1.5).\nNomad can utilize CSI volumes, but it can not automatically create, destroy, or manage them in any capacity. Volumes have to be created externally and then registered with Nomad.\nYou can find a list of plugins in the ",(0,a.kt)("a",{parentName:"p",href:"https://kubernetes-csi.github.io/docs/drivers.html"},"Kubernetes CSI Developer Documentation"),"."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Plugin"),(0,a.kt)("th",{parentName:"tr",align:null},"Schemes"),(0,a.kt)("th",{parentName:"tr",align:null},"Compatible"),(0,a.kt)("th",{parentName:"tr",align:null},"terraform nomad resource"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("a",{parentName:"td",href:"https://github.com/kubernetes-csi/csi-driver-smb"},"kubernetes-csi-driver-smb")),(0,a.kt)("td",{parentName:"tr",align:null},"smb"),(0,a.kt)("td",{parentName:"tr",align:null},"Unknown"),(0,a.kt)("td",{parentName:"tr",align:null},"Unknown")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("a",{parentName:"td",href:"https://github.com/kubernetes-csi/csi-driver-nfs"},"kubernetes-csi-driver-nfs")),(0,a.kt)("td",{parentName:"tr",align:null},"nfs"),(0,a.kt)("td",{parentName:"tr",align:null},"Supported"),(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("a",{parentName:"td",href:"https://registry.terraform.io/providers/hashicorp/nomad/latest/docs/resources/volume"},"nomad_volume"))),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("a",{parentName:"td",href:"https://github.com/kubernetes-csi/csi-driver-iscsi"},"kubernetes-csi-driver-iscsi")),(0,a.kt)("td",{parentName:"tr",align:null},"iscsi"),(0,a.kt)("td",{parentName:"tr",align:null},"Supported"),(0,a.kt)("td",{parentName:"tr",align:null},"Supported")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("a",{parentName:"td",href:"https://github.com/democratic-csi/democratic-csi"},"democraticcsi/democratic-csi")),(0,a.kt)("td",{parentName:"tr",align:null},"smb/nfs/iscsi"),(0,a.kt)("td",{parentName:"tr",align:null},"Supported"),(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("a",{parentName:"td",href:"https://registry.terraform.io/providers/hashicorp/nomad/latest/docs/resources/external_volume"},"nomad_external_volume"))),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("a",{parentName:"td",href:"https://gitlab.com/rocketduck/csi-plugin-nfs"},"rocketduck/csi-plugin-nfs")),(0,a.kt)("td",{parentName:"tr",align:null},"nfs"),(0,a.kt)("td",{parentName:"tr",align:null},"Supported"),(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("a",{parentName:"td",href:"https://registry.terraform.io/providers/hashicorp/nomad/latest/docs/resources/external_volume"},"nomad_external_volume"))))))}c.isMDXComponent=!0}}]);